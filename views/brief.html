{% extends 'layout.html' %}

{% block title %}
  概要
{% endblock %}

{% block head %}
  <script src="js/Chart.bundle.min.js"></script>
  <script src="js/datatables/jquery.dataTables.min.js"></script>
  <script src="js/datatables/dataTables.bootstrap.min.js"></script>
{% endblock %}

{% block content %}
  {% include "partials/navbar.html" %}
  <div class="container">
    {% include "partials/flash.html" %}
  </div>
  <div class="container mt10 pln prn" id="charts-container">
    <div class="page-header">
      <h6>可视化 - 概要<small></small></h6>
    </div>
    <div class="col-md-6">
      <div class="panel panel-info">
        <div class="panel-heading">最近五个月支出</div>
        <div class="panel-body">
          <canvas id="line-pre5month"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="panel panel-info">
        <div class="panel-heading">当月 CPI</div>
        <div class="panel-body">
          <canvas id="pie-this-month"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="panel panel-info">
        <div class="panel-heading" id="category-list-title">各分类支出概要</div>
        <ul class="list-group" id="category-list">
        </ul>
      </div>
    </div>
    <div class="col-md-6">
      <div class="panel panel-info">
        <div class="panel-heading" id="category-list-max-six-title">金额最大六笔支出</div>
        <ul class="list-group" id="category-list-max-six">
        </ul>
      </div>
    </div>
    <div class="col-md-12" id="table-container">
      <div class="panel panel-info">
        <div class="panel-heading">当月支出详细表格</div>
        <div class="panel-body">
          <div id="table-row">
            <div class="col-md-12 center-block">
              <table id="myTables" class="table table-bordered" cellspacing="0" width="100%"></table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block pagejs %}
  <script>
    Chart.defaults.global.legend.display = false
    Chart.defaults.global.responsive = true
    Chart.defaults.global.hover.mode = 'single'
    Chart.defaults.global.hover.animationDuration = 300
    Chart.defaults.global.title.display = true
    Chart.defaults.global.title.position = 'top'
    Chart.defaults.global.title.fullWidth = true
    Chart.defaults.global.title.fontSize = 18

    Chart.defaults.global.animation.animateRotate = true
    Chart.defaults.global.animation.animateScale = true
    Chart.defaults.global.tooltips.enabled = true
    Chart.defaults.global.tooltips.mode = 'single'

    var line_ctx_pre5month = document.getElementById('line-pre5month')
    var colorList = ['#E74C3C', '#1ABC9C', '#2ECC71', '#F39C12', '#3498DB', '#9B59B6']
    var pie_ctx_this_month = document.getElementById('pie-this-month')

    NProgress.start()
    $.getJSON('api/pre5month', function(rsp) {
      if (rsp.message === 0) {
        var yearsData = rsp.data.data
        var titleText = rsp.data.title
      } else {
        yearsData = {
          0: 0
        }
      }
      var yearsKey = []
      var yearsValue = []
      _.each(yearsData, function(value, key) {
        yearsKey.push(key)
        yearsValue.push(value)
      })

      var lineChartPre5Month = new Chart(line_ctx_pre5month, {
        type: 'line',
        data: {
          labels: yearsKey,
          datasets: [{
            data: yearsValue,
            label: '支出',
            fill: false,
            lineTension: 0.1,
            backgroundColor: 'rgba(54, 162, 235, 0.4)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderCapStyle: 'butt',
            borderDash: [],
            borderDashOffset: 0.0,
            borderJoinStyle: 'miter',
            pointBorderColor: 'rgba(75,192,192,1)',
            pointBackgroundColor: '#fff',
            pointBorderWidth: 1,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: 'rgba(54, 162, 235, 1)',
            pointHoverBorderColor: 'rgba(220,220,220,1)',
            pointHoverBorderWidth: 2,
            pointRadius: 1,
            pointHitRadius: 10,
            spanGaps: false,
          }]
        },
        options: {
          title: {
            text: titleText
          },
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true
              }
            }]
          },
          tooltips: {
            enabled: true,
            mode: 'single',
            callbacks: {
              label: function(tooltipItems) {
                return tooltipItems.yLabel + ' 元'
              }
            }
          }
        }
      })
    })

    $.getJSON('api/thismonthpercent', function(rsp) {
      if (rsp.message === 0) {
        var yearsData = rsp.data.data
        var titleText = rsp.data.title
      } else {
        yearsData = {
          0: 0
        }
      }
      var yearsKey = []
      var yearsValue = []
      _.each(yearsData, function(value, key) {
        yearsKey.push(key)
        yearsValue.push(value)
      })

      var data = {
        labels: yearsKey,
        datasets: [{
          data: yearsValue,
          backgroundColor: colorList,
          hoverBackgroundColor: colorList,
        }]
      }

      var myPieChart = new Chart(pie_ctx_this_month, {
        type: 'pie',
        data: data,
        options: {
          title: {
            text: titleText,
          },
          tooltips: {
            callbacks: {
              label: function(tooltipItems, data) {
                return data.labels[tooltipItems.index] + '占比：' + data.datasets[0].data[tooltipItems.index] + '%'
              }
            }
          }
        }
      })
    })

    $.getJSON('api/thismonthsummary', function(rsp) {
      if (rsp.message === 0) {
        var yearsData = rsp.data.data
        var titleText = rsp.data.title
      } else {
        yearsData = {
          0: 0
        }
      }

      $('#category-list-title').text(titleText)

      var colorList = {
        '食品': '#E74C3C',
        '穿': '#1ABC9C',
        '居住': '#2ECC71',
        '交通通信': '#F39C12',
        '教育': '#3498DB',
        '文化娱乐': '#9B59B6'
      }

      _.each(yearsData, function(value, key) {
        var compiled = _.template('<li class="list-group-item"><span class="badge" style="margin-top: 6px; font-size: 13px; background-color:<%= color %>""><%= value %> 元</span><%= key %></li>')
        var tmp = $(compiled({
          key: key,
          value: value,
          color: colorList[key]
        }))
        $('#category-list').append(tmp)
      })
    })

    $.getJSON('api/thismonthmaxsix', function(rsp) {
      if (rsp.message === 0) {
        var yearsData = rsp.data.data
        var titleText = rsp.data.title
      } else {
        yearsData = {
          0: 0
        }
      }

      $('#category-list-max-six-title').text(titleText)

      var colorList = {
        '食品': '#E74C3C',
        '穿': '#1ABC9C',
        '居住': '#2ECC71',
        '交通通信': '#F39C12',
        '教育': '#3498DB',
        '文化娱乐': '#9B59B6'
      }

      _.each(yearsData, function(value) {
        var compiled = _.template('<li class="list-group-item"><span class="badge" style="margin-top: 6px; font-size: 13px; background-color:<%= color %>"><%= value %> 元</span><%= key %></li>')
        var tmp = $(compiled({
          key: value['note'],
          value: value['amount'],
          color: colorList[value['cpi_text']]
        }))
        $('#category-list-max-six').append(tmp)
      })
    })

    $.getJSON('api/thismonthtable', function(rsp) {
      var yearamountData
      if (rsp.message === 0) {
        yearamountData = rsp.data
      }
      var dataSet = yearamountData.reverse()
      $('#myTables').DataTable({
        'data': dataSet,
        'columns': [{
          'data': 'cpi_text',
          'title': '分类 ID'
        }, {
          'data': 'date',
          'title': '时间'
        }, {
          'data': 'amount',
          'title': '金额（元）'
        }, {
          'data': 'note',
          'title': '备注'
        }],
        'autoWidth': true,
        'paging': true,
        'ordering': false,
        'info': true,
        'searching': true,
        'lengthMenu': [
          [10, 25, 50, 100, -1],
          [10, 25, 50, 100, '全部']
        ],
        'language': {
          'lengthMenu': '每页 _MENU_ 条记录',
          'zeroRecords': '没有找到',
          'info': '第 _PAGE_ 页，总 _PAGES_ 页',
          'infoEmpty': '没有记录',
          'infoFiltered': '(从 _MAX_ 条记录中过滤)',
          'search': '搜索：',
          'emptyTable': '这张表中没有数据',
          'loadingRecords': '加载中...',
          'processing': '处理中...',
          'paginate': {
            'first': '第一页',
            'last': '末页',
            'next': '下一页',
            'previous': '上一页'
          }
        }
      })
    })
    NProgress.done()
  </script>
{% endblock %}
